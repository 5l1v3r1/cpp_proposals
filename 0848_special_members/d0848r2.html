<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="mpark/wg21" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2019-06-06" />
  <title>Conditionally Trivial Special Member Functions</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f6f8fa; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { } /* Normal */
code span.al { color: #ff0000; } /* Alert */
code span.an { } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #9f6807; } /* BaseN */
code span.bu { color: #9f6807; } /* BuiltIn */
code span.cf { color: #00607c; } /* ControlFlow */
code span.ch { color: #9f6807; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; font-style: italic; } /* Comment */
code span.cv { color: #008000; font-style: italic; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.dt { color: #00607c; } /* DataType */
code span.dv { color: #9f6807; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #9f6807; } /* Float */
code span.fu { } /* Function */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #00607c; } /* Keyword */
code span.op { color: #af1915; } /* Operator */
code span.ot { } /* Other */
code span.pp { color: #6f4e37; } /* Preprocessor */
code span.re { } /* RegionMarker */
code span.sc { color: #9f6807; } /* SpecialChar */
code span.ss { color: #9f6807; } /* SpecialString */
code span.st { color: #9f6807; } /* String */
code span.va { } /* Variable */
code span.vs { color: #9f6807; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
code.diff span.va {color: #006e28}
code.diff span.st {color: #bf0303}
  </style>
  <style type="text/css">
body {
margin: 5em;
font-family: serif;

hyphens: auto;
line-height: 1.35;
}
div.wrapper {
max-width: 60em;
margin: auto;
}
ul {
list-style-type: none;
padding-left: 2em;
margin-top: -0.2em;
margin-bottom: -0.2em;
}
a { text-decoration: none; }
a.hidden_link {
text-decoration: none;
color: inherit;
}
li {
margin-top: 0.6em;
margin-bottom: 0.6em;
}
h1 { line-height: 1; }
h2 { line-height: 1; }
h3 { line-height: 1; }
h4 { line-height: 1; }
ul > li:before {
content: "\2014";
position: absolute;
margin-left: -1.5em;
}
:target { background-color: #C9FBC9; }
:target .codeblock { background-color: #C9FBC9; }
:target ul { background-color: #C9FBC9; }
.abbr_ref { float: right; }
.folded_abbr_ref { float: right; }
:target .folded_abbr_ref { display: none; }
:target .unfolded_abbr_ref { float: right; display: inherit; }
.unfolded_abbr_ref { display: none; }
.secnum { display: inline-block; min-width: 35pt; }
.header-section-number { display: inline-block; min-width: 35pt; }
.annexnum { display: block; }
div.sourceLinkParent {
float: right;
}
a.sourceLink {
position: absolute;
opacity: 0;
margin-left: 10pt;
}
a.sourceLink:hover {
opacity: 1;
}
a.itemDeclLink {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
opacity: 0;
}
a.itemDeclLink:hover { opacity: 1; }
div.marginalizedparent {
position: relative;
left: -5em;
}
li > div.marginalizedparent { left: -7em; }
li > ul > li > div.marginalizedparent { left: -9em; }
li > ul > li > ul > li > div.marginalizedparent { left: -11em; }
li > ul > li > ul > li > ul > li > div.marginalizedparent { left: -13em; }
div.footnoteNumberParent {
position: relative;
left: -4.7em;
}
a.marginalized {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
}
a.enumerated_item_num {
position: relative;
left: -3.5em;
display: inline-block;
margin-right: -3em;
text-align: right;
width: 3em;
}
div.para { margin-bottom: 0.6em; margin-top: 0.6em; text-align: justify; }
div.section { text-align: justify; }
div.sentence { display: inline; }
span.indexparent {
display: inline;
position: relative;
float: right;
right: -1em;
}
a.index {
position: absolute;
display: none;
}
a.index:before { content: "⟵"; }

a.index:target {
display: inline;
}
.indexitems {
margin-left: 2em;
text-indent: -2em;
}
div.itemdescr {
margin-left: 3em;
}
.bnf {
font-family: serif;
margin-left: 40pt;
margin-top: 0.5em;
margin-bottom: 0.5em;
}
.ncbnf {
font-family: serif;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
}
.ncsimplebnf {
font-family: serif;
font-style: italic;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
background: inherit; 
}
span.textnormal {
font-style: normal;
font-family: serif;
white-space: normal;
display: inline-block;
}
span.rlap {
display: inline-block;
width: 0px;
}
span.descr { font-style: normal; font-family: serif; }
span.grammarterm { font-style: italic; }
span.term { font-style: italic; }
span.terminal { font-family: monospace; font-style: normal; }
span.nonterminal { font-style: italic; }
span.tcode { font-family: monospace; font-style: normal; }
span.textbf { font-weight: bold; }
span.textsc { font-variant: small-caps; }
a.nontermdef { font-style: italic; font-family: serif; }
span.emph { font-style: italic; }
span.techterm { font-style: italic; }
span.mathit { font-style: italic; }
span.mathsf { font-family: sans-serif; }
span.mathrm { font-family: serif; font-style: normal; }
span.textrm { font-family: serif; }
span.textsl { font-style: italic; }
span.mathtt { font-family: monospace; font-style: normal; }
span.mbox { font-family: serif; font-style: normal; }
span.ungap { display: inline-block; width: 2pt; }
span.textit { font-style: italic; }
span.texttt { font-family: monospace; }
span.tcode_in_codeblock { font-family: monospace; font-style: normal; }
span.phantom { color: white; }

span.math { font-style: normal; }
span.mathblock {
display: block;
margin-left: auto;
margin-right: auto;
margin-top: 1.2em;
margin-bottom: 1.2em;
text-align: center;
}
span.mathalpha {
font-style: italic;
}
span.synopsis {
font-weight: bold;
margin-top: 0.5em;
display: block;
}
span.definition {
font-weight: bold;
display: block;
}
.codeblock {
margin-left: 1.2em;
line-height: 127%;
}
.outputblock {
margin-left: 1.2em;
line-height: 127%;
}
code {
font-family: monospace;
font-style: normal;
}
div.itemdecl {
margin-top: 2ex;
}
code.itemdeclcode {
white-space: pre;
display: block;
}
span.textsuperscript {
vertical-align: super;
font-size: smaller;
line-height: 0;
}
.footnotenum { vertical-align: super; font-size: smaller; line-height: 0; }
.footnote {
font-size: small;
margin-left: 2em;
margin-right: 2em;
margin-top: 0.6em;
margin-bottom: 0.6em;
}
div.minipage {
display: inline-block;
margin-right: 3em;
}
div.numberedTable {
text-align: center;
margin: 2em;
}
div.figure {
text-align: center;
margin: 2em;
}
table {
border: 1px solid black;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
margin-top: 0.8em;
text-align: left;
hyphens: none; 
}
td, th {
padding-left: 1em;
padding-right: 1em;
vertical-align: top;
}
td.empty {
padding: 0px;
padding-left: 1px;
}
td.left {
text-align: left;
}
td.right {
text-align: right;
}
td.center {
text-align: center;
}
td.justify {
text-align: justify;
}
td.border {
border-left: 1px solid black;
}
tr.rowsep, td.cline {
border-top: 1px solid black;
}
tr.even, tr.odd {
border-bottom: 1px solid black;
}
tr.capsep {
border-top: 3px solid black;
border-top-style: double;
}
tr.header {
border-bottom: 3px solid black;
border-bottom-style: double;
}
th {
border-bottom: 1px solid black;
}
span.centry {
font-weight: bold;
}
div.table {
display: block;
margin-left: auto;
margin-right: auto;
text-align: center;
width: 90%;
}
span.indented {
display: block;
margin-left: 2em;
margin-bottom: 1em;
margin-top: 1em;
}
ol.enumeratea { list-style-type: none; background: inherit; }
ol.enumerate { list-style-type: none; background: inherit; }
</style>
  <style type="text/css">a {
color : #4183C4;
text-decoration: underline;
}
a.marginalized {
text-decoration: none;
}
a.self-link {
position: absolute;
left: calc(-1 * (3.5rem - 26px));
width: calc(3.5rem - 26px);
bottom: 1px;
text-align: center;
border: none;
transition: opacity .2s;
opacity: .5;
text-decoration: none;
}
a.self-link:hover {
opacity: 1;
}
a.self-link::before {
content: "§";
}
h1#toctitle {
border-bottom: 1px solid #cccccc;
}
#TOC li {
margin-top: 1px;
margin-bottom: 1px;
}
#TOC ul>li:before { display: none; }
h3.subtitle { margin-top: -15px; }
h1:target { background-color: transparent; }
h2:target { background-color: transparent; }
h3:target { background-color: transparent; }
h4:target { background-color: transparent; }
h5:target { background-color: transparent; }
h6:target { background-color: transparent; }
h1,h2,h3,h4,h5,h6 { position: relative; }
code span.co { font-family: monospace; }
table tr {
background-color: white;
}
table tr:nth-child(2n) {
background-color: #f6f8fa;
}
#title-block-header > table tr:nth-child(2n) {
background-color: white;
}
td > div.sourceCode {
background-color: inherit;
}
table {
border-collapse: collapse;
}
table td, table th {
border: 1px solid #cccccc;
}
table th {
border-bottom: 1px solid black;
}
table tr:first-child th {
border-top: 0;
}
table tr:last-child td {
border-bottom: 0;
}
table tr td:first-child,
table tr th:first-child {
border-left: 0;
}
table tr td:last-child,
table tr th:last-child {
border-right: 0;
}
table tbody tr:first-child td {
border-top: 1px solid black;
}
#title-block-header td { border: 0; }
@media all {
body {
margin: 2em;
}
}
@media screen and (min-width: 480px) {
body {
margin: 5em;
}
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
</head>
<body>
<div class="wrapper">
<header id="title-block-header">
<h1 class="title" style="text-align:center">Conditionally Trivial Special Member Functions</h1>

<table style="border:none;float:right">
  <tr>
    <td>Document #: </td>
    <td>D0848R2</td>
  </tr>
  <tr>
    <td>Date: </td>
    <td>2019-06-06</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Project: </td>
    <td>Programming Language C++<br>
      CWG<br>
    </td>
  </tr>
  <tr>
    <td style="vertical-align:top">Reply-to: </td>
    <td>
      Barry Revzin<br>&lt;<a href="mailto:barry.revzin@gmail.com" class="email">barry.revzin@gmail.com</a>&gt;<br>
      Casey Carter<br>&lt;<a href="mailto:casey@carter.net" class="email">casey@carter.net</a>&gt;<br>
    </td>
  </tr>
</table>

</header>
<div style="clear:both">
<div id="TOC" role="doc-toc">
<h1 id="toctitle">Contents</h1>
<ul>
<li><a href="#revision-history"><span class="toc-section-number">1</span> <span></span>Revision History</a></li>
<li><a href="#introduction"><span class="toc-section-number">2</span> <span></span>Introduction</a></li>
<li><a href="#proposal"><span class="toc-section-number">3</span> <span></span>Proposal</a></li>
<li><a href="#wording"><span class="toc-section-number">4</span> <span></span>Wording</a></li>
<li><a href="#acknowledgments"><span class="toc-section-number">5</span> <span></span>Acknowledgments</a></li>
<li><a href="#references"><span class="toc-section-number">6</span> <span></span>References</a></li>
</ul>
</div>
<h1 id="revision-history" style="border-bottom:1px solid #cccccc"><span class="header-section-number">1</span> <a href="#revision-history" class="self-link"></a>Revision History</h1>
<p><span class="citation" data-cites="P0848R0">[<a href="#ref-P0848R0" role="doc-biblioref">P0848R0</a>]</span> was presented to EWG at the San Diego meeting (November 2018). It proposed to change the rules for trivially copyable such that we only consider the <em>best viable candidate</em> amongst the copy constructors given a synthesized overload resolution. That is, depending on <code class="sourceCode cpp">C<span class="op">&lt;</span>T<span class="op">&gt;</span></code>, we either consider only <code class="sourceCode cpp"><span class="pp">#2</span></code> (because <code class="sourceCode cpp"><span class="pp">#1</span></code> wouldn’t be viable) or only <code class="sourceCode cpp"><span class="pp">#1</span></code> (because it would be more constrained than <code class="sourceCode cpp"><span class="pp">#2</span></code> and hence a better match). However, EWG considered this to be confusing as trivially copyable is a property of a type and adding overload resolution simply adds more questions about context (e.g. do we consider accessibility?). EWG requested a new mechanism to solve this problem.</p>
<p><span class="citation" data-cites="P0848R1">[<a href="#ref-P0848R1" role="doc-biblioref">P0848R1</a>]</span> was also presented to EWG in San Diego, proposed to introduce an intermediate layer: a constructor for a class <code class="sourceCode cpp">X</code> of the form <code class="sourceCode cpp">X<span class="op">(</span>X <span class="kw">const</span><span class="op">&amp;)</span></code> rather than being considered a copy constructor would instead become a <em>prospective copy constructor</em>, and a <em>copy constructor</em> would be any prospective copy constructor whose constraints are satisfied and is at least as constrained as every other prospective copy constructor. In this way, we don’t change the definition of trivially copyable at all - we change the definition for each of the special member functions.</p>
<p>During Core wording review in the Kona meeting (February 2019), a new direction was suggested that is somewhat of a compromise between the two other positions: we use the “constraints are satisfied and is at least as constrained as” rule on the special member functions, but we only apply it to the trivially copyable rules. This ensures that we maintain these as properties of the type rather than properties of an expression - and is the direction this paper takes.</p>
<h1 id="introduction" style="border-bottom:1px solid #cccccc"><span class="header-section-number">2</span> <a href="#introduction" class="self-link"></a>Introduction</h1>
<p>For a complete motivation for this proposal, see <span class="citation" data-cites="P0848R0">[<a href="#ref-P0848R0" role="doc-biblioref">P0848R0</a>]</span>. In brief, it is important for certain class template instantiations to propagate the triviality from their template parameters - that is, we want <code class="sourceCode cpp">wrapper<span class="op">&lt;</span>T<span class="op">&gt;</span></code> to be trivially copyable if and only if <code class="sourceCode cpp">T</code> is copyable. In C++17, this is possible, yet is extremely verbose. The introduction of Concepts provides a path to make this propagation substantially easier to write, but the current definition of trivially copyable doesn’t quite suffice for what we want.</p>
<p>Consider:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">concept</span> C <span class="op">=</span> <span class="co">/* ... */</span>;</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">struct</span> X <span class="op">{</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="co">// #1</span></a>
<a class="sourceLine" id="cb1-7" title="7">    X<span class="op">(</span>X <span class="kw">const</span><span class="op">&amp;)</span> <span class="kw">requires</span> C<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> <span class="cf">default</span>;</a>
<a class="sourceLine" id="cb1-8" title="8">    </a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="co">// #2</span></a>
<a class="sourceLine" id="cb1-10" title="10">    X<span class="op">(</span>X <span class="kw">const</span><span class="op">&amp;</span> <span class="op">)</span> <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="op">}</span>;</a></code></pre></div>
<p>According to the current working draft, both <code class="sourceCode cpp"><span class="pp">#1</span></code> and <code class="sourceCode cpp"><span class="pp">#2</span></code> are copy constructors. The current definition for trivially copyable requires that <em>each</em> copy constructor be either deleted or trivial. That is, we always consider both copy constructors, regardless of <code class="sourceCode cpp">T</code> and <code class="sourceCode cpp">C<span class="op">&lt;</span>T<span class="op">&gt;</span></code>, and hence no instantation of <code class="sourceCode cpp">X</code> is ever trivially copyable.</p>
<p>This paper suggests that those specializations <code class="sourceCode cpp">X<span class="op">&lt;</span>T<span class="op">&gt;</span></code> for which <code class="sourceCode cpp">T</code> satisfies <code class="sourceCode cpp">C</code> should be considered trivially copyable - this very logically follows the model of constraints and would make it substantially easier to write class templates that are conditionally trivially copyable. Indeed, it would become actually easy to do such a thing rather than quite complex with multiple layers of conditional base classes.</p>
<h1 id="proposal" style="border-bottom:1px solid #cccccc"><span class="header-section-number">3</span> <a href="#proposal" class="self-link"></a>Proposal</h1>
<p>The current relevant definitions in [class.prop] read:</p>
<blockquote>
<p>A <em>trivially copyable class</em> is a class:</p>
<ul>
<li>where each copy constructor, move constructor, copy assignment operator, and move assignment operator ([class.copy.ctor], [class.copy.assign]) is either deleted or trivial,</li>
<li>that has at least one non-deleted copy constructor, move constructor, copy assignment operator, or move assignment operator, and</li>
<li>that has a trivial, non-deleted destructor.</li>
</ul>
</blockquote>
<blockquote>
<p>A <em>trivial class</em> is a class that is trivially copyable and has one or more default constructors ([class.default.ctor]), all of which are either trivial or deleted and at least one of which is not deleted.</p>
</blockquote>
<p>There are two aspects of these definitions that need to be changed for this proposal: one that applies to five of the special member functions in the same way (the copy and move constructors and assignment operators and the default constructor), and one that applies specifically to the destructor.</p>
<p>For the five non-destructor special member functions, we introduce a new concept called an <em>eligible special member function</em> - which is a special member function that is:</p>
<ul>
<li>not deleted</li>
<li>has all of its constraints (if any) satisfied</li>
<li>no special member function of the same kind, with the same first parameter type (except for the default constructor), is more constrained</li>
</ul>
<p>And then simplify the definitions of <em>trivially copyable</em> and <em>trivial</em> to use eligible special members instead of just any special members.</p>
<p>For the destructor, we go in a slightly different direction. We introduce a sub-classification called a <em>prospective destructor</em> which is simply any function declared for a class <code class="sourceCode cpp">X</code> that is spelled <code class="sourceCode cpp"><span class="op">~</span>X<span class="op">()</span></code> with some constraints, and then redefine destructor to be the eligible destructor, requiring that there be only one.</p>
<p>Using the example from R0:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">struct</span> optional <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="co">// #1</span></a>
<a class="sourceLine" id="cb2-4" title="4">    optional<span class="op">(</span>optional <span class="kw">const</span><span class="op">&amp;)</span></a>
<a class="sourceLine" id="cb2-5" title="5">        <span class="kw">requires</span> TriviallyCopyConstructible<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">&amp;&amp;</span> CopyConstructible<span class="op">&lt;</span>T<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb2-6" title="6">        <span class="op">=</span> <span class="cf">default</span>;</a>
<a class="sourceLine" id="cb2-7" title="7">        </a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="co">// #2</span></a>
<a class="sourceLine" id="cb2-9" title="9">    optional<span class="op">(</span>optional <span class="kw">const</span><span class="op">&amp;</span> rhs<span class="op">)</span></a>
<a class="sourceLine" id="cb2-10" title="10">            <span class="kw">requires</span> CopyConstructible<span class="op">&lt;</span>T<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb2-11" title="11">       <span class="op">:</span> engaged<span class="op">(</span>rhs<span class="op">.</span>engaged<span class="op">)</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="op">{</span></a>
<a class="sourceLine" id="cb2-13" title="13">        <span class="cf">if</span> <span class="op">(</span>engaged<span class="op">)</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-14" title="14">            <span class="kw">new</span> <span class="op">(</span>value<span class="op">)</span> T<span class="op">(</span>rhs<span class="op">.</span>value<span class="op">)</span>;</a>
<a class="sourceLine" id="cb2-15" title="15">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="op">}</span>;</a></code></pre></div>
<p>For all specializations, we have two copy constructors: <code class="sourceCode cpp"><span class="pp">#1</span></code> and <code class="sourceCode cpp"><span class="pp">#2</span></code>. For <code class="sourceCode cpp">T<span class="op">=</span>unique_ptr<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span></code>, neither copy constructor has its constraints satisfied so there is no eligible copy constructor. For <code class="sourceCode cpp">T<span class="op">=</span>std<span class="op">::</span>string</code>, only <code class="sourceCode cpp"><span class="pp">#2</span></code> has its constraints satisfied, so only <code class="sourceCode cpp"><span class="pp">#2</span></code> is an eligible copy constructor. For <code class="sourceCode cpp">T<span class="op">=</span><span class="dt">int</span></code>, both <code class="sourceCode cpp"><span class="pp">#1</span></code> and <code class="sourceCode cpp"><span class="pp">#2</span></code> have their constraints satisfied. <code class="sourceCode cpp"><span class="pp">#1</span></code> is more constrained than <code class="sourceCode cpp"><span class="pp">#2</span></code>, so only <code class="sourceCode cpp"><span class="pp">#1</span></code> is an eligible copy constructor.</p>
<h1 id="wording" style="border-bottom:1px solid #cccccc"><span class="header-section-number">4</span> <a href="#wording" class="self-link"></a>Wording</h1>
<p>Change 6.6.7/p1 [class.temporary] to refer to the future definition of eligibility:</p>
<blockquote>
<p>When an object of class type <code class="sourceCode cpp">X</code> is passed to or returned from a function, if each <span class="add" style="color: #006e28"><ins>eligible</ins></span> copy constructor <span class="add" style="color: #006e28"><ins>([class.prop])</ins></span> <span class="rm" style="color: #bf0303"><del>,</del></span> <span class="add" style="color: #006e28"><ins>and</ins></span> move constructor <span class="add" style="color: #006e28"><ins>is trivial, the</ins></span> destructor of X is either trivial or deleted, and <code class="sourceCode cpp">X</code> has at least one <span class="rm" style="color: #bf0303"><del>non-deleted</del></span> <span class="add" style="color: #006e28"><ins>eligible</ins></span> copy or move constructor, implementations are permitted to create a temporary object to hold the function parameter or result object. The temporary object is constructed from the function argument or return value, respectively, and the function’s parameter or return object is initialized as if by using the <span class="rm" style="color: #bf0303"><del>non-deleted</del></span> <span class="add" style="color: #006e28"><ins>eligible</ins></span> trivial constructor to copy the temporary (even if that constructor is inaccessible or would not be selected by overload resolution to perform a copy or move of the object).</p>
</blockquote>
<p>And likewise for 7.6.1.2/p12 [expr.call]:</p>
<blockquote>
<p>Passing a potentially-evaluated argument of class type having a non-trivial <span class="add" style="color: #006e28"><ins>eligible</ins></span> copy constructor <span class="add" style="color: #006e28"><ins>([class.prop])</ins></span>, a non-trivial <span class="add" style="color: #006e28"><ins>eligible</ins></span> move constructor, or a non-trivial destructor, with no corresponding parameter, is conditionally-supported with implementation-defined semantics.</p>
</blockquote>
<p>Change 9.4.2/p5 [dcl.fct.def.default] to account for prospective destructors that aren’t destructors:</p>
<blockquote>
<p>Explicitly-defaulted functions and implicitly-declared functions are collectively called <em>defaulted</em> functions, and the implementation shall provide implicit definitions for them ([class.ctor] [class.dtor], [class.copy.ctor], [class.copy.assign]), which might mean defining them as deleted. <span class="add" style="color: #006e28"><ins>A defaulted prospective destructor ([class.dtor]) that is not a destructor shall be defined as deleted. A defaulted special member function that is not an eligible special member function ([class.prop]) shall be defined as deleted.</ins></span> A function is <em>user-provided</em> if it is user-declared and not explicitly defaulted or deleted on its first declaration.</p>
</blockquote>
<p>Insert at the beginning of 11.1 [class.prop] a definition of eligibility:</p>
<div class="add" style="color: #006e28">

<blockquote>
<p><div class="marginalizedparent"><a class="marginalized">0</a></div> An <em>eligible special member function</em> is a special member function ([special]):</p>
<ul>
<li><div class="marginalizedparent"><a class="marginalized">(0.1)</a></div> that is not deleted,</li>
<li><div class="marginalizedparent"><a class="marginalized">(0.2)</a></div> where each of its associated constraints ([temp.constr]), if any, are satisfied, and</li>
<li><div class="marginalizedparent"><a class="marginalized">(0.3)</a></div> no special member function of the same kind with the same first parameter type (if any) is more constrained ([temp.constr.order]).</li>
</ul>
</blockquote>

</div>
<p>Change the definitions of <em>trivially copyable</em> and <em>trivial</em> in 11.1/p1 [class.prop]:</p>
<blockquote>
<p><div class="marginalizedparent"><a class="marginalized">1</a></div> A <em>trivially copyable class</em> is a class:</p>
<ul>
<li><div class="marginalizedparent"><a class="marginalized">(1.1)</a></div> where each <span class="add" style="color: #006e28"><ins>eligible</ins></span> copy constructor, move constructor, copy assignment operator, and move assignment operator ([class.copy.ctor], [class.copy.assign]) is <span class="rm" style="color: #bf0303"><del>either deleted or</del></span> trivial,</li>
<li><div class="marginalizedparent"><a class="marginalized">(1.2)</a></div> that has at least one <span class="rm" style="color: #bf0303"><del>non-deleted</del></span> <span class="add" style="color: #006e28"><ins>eligible</ins></span> copy constructor, move constructor, copy assignment operator, or move assignment operator, and</li>
<li><div class="marginalizedparent"><a class="marginalized">(1.3)</a></div> that has a trivial, non-deleted destructor.</li>
</ul>
</blockquote>
<blockquote>
<p><div class="marginalizedparent"><a class="marginalized">2</a></div> A <em>trivial class</em> is a class that is trivially copyable and has one or more <span class="add" style="color: #006e28"><ins>eligible</ins></span> default constructors ([class.default.ctor]), all of which are <span class="add" style="color: #006e28"><ins>trivial.</ins></span> <span class="rm" style="color: #bf0303"><del>either trivial or deleted and at least one of which is not deleted.</del></span></p>
</blockquote>
<p>Change 11.3.3/p1 [special] to refer to prospective destructors, and make everything plural:</p>
<blockquote>
<p><span class="rm" style="color: #bf0303"><del>The default</del></span> <span class="add" style="color: #006e28"><ins>Default</ins></span> constructor<span class="add" style="color: #006e28"><ins>s</ins></span> ([class.default.ctor]), copy constructor<span class="add" style="color: #006e28"><ins>s</ins></span>, move constructor<span class="add" style="color: #006e28"><ins>s</ins></span> ([class.copy.ctor]), copy assignment operator<span class="add" style="color: #006e28"><ins>s</ins></span>, move assignment operator<span class="add" style="color: #006e28"><ins>s</ins></span> ([class.copy.assign]), and <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor<span class="add" style="color: #006e28"><ins>s</ins></span> ([class.dtor]) are <em>special member functions</em>.</p>
</blockquote>
<p>Change the definition of destructor as follows.</p>
<p>Change 11.3.6 [class.dtor], paragraph 1:</p>
<blockquote>
<p>In a declaration of a <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor, the declarator is a function declarator (9.2.3.5) of the form […] A <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor shall take no arguments (9.2.3.5). Each <em>decl-specifier</em> of the <em>decl-specifier-seq</em> of a <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor declaration (if any) shall be <code class="sourceCode cpp"><span class="kw">friend</span></code>, <code class="sourceCode cpp"><span class="kw">inline</span></code>, or <code class="sourceCode cpp"><span class="kw">virtual</span></code>.</p>
</blockquote>
<blockquote>
<p><span class="add" style="color: #006e28"><ins>At the end of the definition of a class, overload resolution is performed among the prospective destructors declared in that class with an empty argument list to select the <em>destructor</em> for the class. The program is ill-formed if overload resolution fails. Destructor selection does not constitute a reference to ([dcl.fct.def.delete]) or odr-use of ([basic.def.odr]) the selected destructor, and in particular, the selected destructor may be deleted.</ins></span></p>
</blockquote>
<p>Change 11.3.6 [class.dtor], paragraph 4:</p>
<blockquote>
<p>If a class has no user-declared <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor, a <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor is implicitly declared as defaulted (9.4). An implicitly-declared <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor is an inline public member of its class.</p>
</blockquote>
<div class="add" style="color: #006e28">

<blockquote>
<p>An implicitly-declared prospective destructor for a class X will have the form</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" title="1"><span class="op">~</span>X<span class="op">()</span></a></code></pre></div>
</blockquote>

</div>
<p>Change 11.3.6 [class.dtor], paragraph 10:</p>
<blockquote>
<p>A <span class="add" style="color: #006e28"><ins>prospective</ins></span> destructor can be declared <code class="sourceCode cpp"><span class="kw">virtual</span></code> (11.6.2) or pure <code class="sourceCode cpp"><span class="kw">virtual</span></code> (11.6.3); if <span class="add" style="color: #006e28"><ins>the destructor of a class is <span><code class="sourceCode cpp"><span class="kw">virtual</span></code></span> and</ins></span> any objects of that class or any derived class are created in the program, the destructor shall be defined. If a class has a base class with a virtual destructor, its destructor (whether user- or implicitly-declared) is virtual.</p>
</blockquote>
<h1 id="acknowledgments" style="border-bottom:1px solid #cccccc"><span class="header-section-number">5</span> <a href="#acknowledgments" class="self-link"></a>Acknowledgments</h1>
<p>Thanks to Gaby dos Reis, Daveed Vandevoorde, and Jonathan Wakely for helping bring us to this design. Thanks to Jens Maurer and Richard Smith for the lengthy discussions and wording wizardry.</p>
<h1 id="references" style="border-bottom:1px solid #cccccc"><span class="header-section-number">6</span> <a href="#references" class="self-link"></a>References</h1>

<div id="refs" role="doc-bibliography">
<div id="ref-P0848R0">
<p>[P0848R0] Barry Revzin, Casey Carter. 2017. Conditionally Trivial Special Member Functions. <br />
<a href="https://wg21.link/p0848r0">https://wg21.link/p0848r0</a></p>
</div>
<div id="ref-P0848R1">
<p>[P0848R1] Barry Revzin, Casey Carter. 2019. Conditionally Trivial Special Member Functions. <br />
<a href="https://wg21.link/p0848r1">https://wg21.link/p0848r1</a></p>
</div>
</div>
</div>
</div>
</body>
</html>
